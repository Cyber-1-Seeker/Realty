# Система Мониторинга и Аналитики

## Описание

Система автоматически подсчитывает:
- **Визиты** - **КАЖДЫЙ переход на любую страницу сайта** (+1 за каждый переход)
- **Уникальные IP** - новые IP-адреса за день
- **Регистрации** - новые пользователи
- **Заявки** - созданные заявки

## ⚠️ ВАЖНО: Новая логика подсчета визитов

**Раньше:** Считались только новые сессии пользователей
**Теперь:** Считается **КАЖДЫЙ переход** на любую страницу сайта

### Примеры:
- Переход на главную → +1 к визитам
- Переход в профиль → +1 к визитам  
- Переход в базу квартир → +1 к визитам
- Перезагрузка страницы → +1 к визитам
- Переход на любую другую страницу → +1 к визитам

## Команды управления

### Просмотр статистики
```bash
python manage.py test_stats --action=show
```

### Создание тестовых данных
```bash
python manage.py test_stats --action=create
```

### Сброс статистики
```bash
python manage.py test_stats --action=reset
```

### Тестирование middleware
```bash
python manage.py test_middleware --visits=5
```

### Тестирование переходов по страницам
```bash
python manage.py test_page_visits --pages=10
```

### Очистка тестовых данных
```bash
# Очистить только сегодня
python manage.py clean_test_data --action=clean_today

# Очистить все счетчики
python manage.py clean_test_data --action=clean_all

# Полный сброс
python manage.py clean_test_data --action=reset
```

## Тестовая страница

Для проверки работы middleware откройте:
- `/test/` - тестовая страница с интерфейсом
- `/api/monitoring/api/stats/` - API для получения статистики

## Как это работает

1. **Middleware** (`SmartVisitMiddleware`) автоматически срабатывает при каждом запросе
2. **Фильтрация** - обрабатываются ВСЕ страницы сайта (кроме статических файлов и API)
3. **Подсчет визитов** - **+1 за каждый переход** на любую страницу
4. **Подсчет уникальных IP** - +1 за каждый новый IP-адрес за день
5. **Защита от дублирования** - middleware срабатывает только один раз за запрос

## Что обрабатывается

### ✅ Считаются как визиты:
- `/` - Главная
- `/home` - Домашняя  
- `/about` - О нас
- `/listings` - Объявления
- `/profile` - Профиль
- `/contact` - Контакты
- `/support` - Поддержка
- `/privacy` - Приватность
- `/test/` - Тестовая страница
- **Любые другие страницы сайта**

### ❌ НЕ считаются как визиты:
- Статические файлы (.js, .css, .png, .jpg, .svg, .ico)
- API вызовы (/api/*)
- Админка (/admin/*)
- AJAX запросы

## Логирование

Все действия middleware логируются в:
- Консоль (при DEBUG=True)
- Файл `logs/django_errors.log`

## Решение проблем

### Статистика не обновляется
1. Проверьте, что middleware подключен в `settings.py`
2. Убедитесь, что страница не является статическим файлом или API
3. Проверьте логи на наличие ошибок

### Счетчик увеличивается на +4 или +10
1. Middleware срабатывает несколько раз
2. Используйте команду `clean_test_data` для очистки
3. Проверьте настройки сессий

### Нет данных в админке
1. Запустите `python manage.py test_stats --action=create`
2. Проверьте, что модели зарегистрированы в `admin.py`

## Тестирование

Для проверки работы используйте:
```bash
# Тест обычных визитов
python manage.py test_middleware --visits=5

# Тест переходов по страницам  
python manage.py test_page_visits --pages=10

# Ожидаемый результат: счетчик визитов = количество страниц
```
